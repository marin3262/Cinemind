# 2025-11-22: '트렌드' 탭 UI 개편 및 연쇄 오류 해결, 그리고 전체 안정화

## 1. 주요 작업 요약 (Executive Summary)

본 세션의 초기 목표는 '트렌드' 탭의 UI를 사용자의 피드백에 맞춰 개선하는 것이었으나, 이 과정에서 프론트엔드와 백엔드를 넘나드는 수많은 연쇄 오류가 발생하며 이를 해결하는 데 대부분의 시간을 할애했습니다.

오류의 원인은 주로 `replace` 도구의 미숙한 사용으로 인한 코드 구조 손상, Python 버전 비호환성 미인지, 그리고 복원 과정에서 함수의 내용물이 유실된 불완전한 코드를 덮어쓰는 치명적인 실수의 반복이었습니다.

수많은 디버깅과 '파일 완전 복원' 조치를 통해, 최종적으로 모든 오류를 해결하고 앱을 **완전히 안정적인 상태로 복원**하는 데 성공했습니다. 이 과정에서 몇몇 버그가 영구적으로 수정되었고, 코드의 일부(백엔드 날짜 처리, 트렌드 탭 구조 등)는 오히려 이전보다 더 개선되었습니다.

## 2. 기능별 상세 역할 및 로직 분석 (Feature-by-Feature Analysis)

### 2.1. `trends.tsx` 컴포넌트화 (UI 구조 개선)
- **역할(Role):** 거대했던 `trends.tsx` 파일을 `BoxOfficeSection`, `BattleSection` 등 논리적 단위의 하위 컴포넌트로 분리하여, 코드의 가독성과 유지보수성을 향상시키는 역할을 합니다. 부모인 `trends.tsx`는 각 섹션 컴포넌트를 조립하고 필요한 데이터를 전달하는 컨테이너 역할만 수행합니다.
- **작동 원리(Logic):**
    1. `trends.tsx`는 자신의 `useEffect` 훅을 통해 박스오피스, 오늘의 매치업 등 모든 관련 데이터를 API로부터 가져옵니다.
    2. 가져온 데이터(예: `boxOfficeMovies`)와 상태 변경 함수(예: `setSortBy`)를 각 하위 컴포넌트(`BoxOfficeSection` 등)에 `props`로 전달합니다.
    3. 각 하위 컴포넌트는 전달받은 `props`를 사용하여 자신만의 UI를 렌더링하고, 사용자 이벤트가 발생하면 `props`로 받은 함수를 호출하여 부모에게 알립니다.
- **변경 사유(Reason for Change):** 단일 파일에 모든 로직이 혼재하여 수정이 어렵고 오류 발생 가능성이 높았기 때문입니다. 이를 '관심사의 분리(Separation of Concerns)' 원칙에 따라 분리하여 코드의 복잡도를 낮추고 안정성을 높였습니다.

### 2.2. 백엔드 캐싱 로직 및 날짜 처리 개선 (`routers/movies.py`)
- **역할(Role):** `trending`, `top_rated` 등 자주 호출되지만 내용이 자주 바뀌지 않는 API의 응답을 DB에 임시 저장(캐싱)하는 역할을 합니다. 이를 통해 불필요한 외부 API(TMDB) 호출을 줄여, 응답 속도를 높이고 서버 부하와 비용을 절감합니다.
- **작동 원리(Logic):**
    1. **`python-dateutil` 라이브러리 도입:** 다양한 형식의 ISO 8601 날짜 문자열(예: `...Z`, `...+00:00`)을 안정적으로 파싱하기 위해 `dateutil.parser.isoparse()` 함수를 도입했습니다. 이는 기존의 불안정했던 `datetime.strptime` 로직을 대체하여 날짜 관련 `ValueError`를 원천적으로 해결합니다.
    2. **API 요청 수신:** 요청을 받으면, 먼저 `cached_lists` 테이블에서 `list_type`으로 캐시 데이터가 있는지 조회합니다.
    3. **캐시 유효성 검사:** 캐시가 존재하면, 데이터의 `last_updated` 타임스탬프를 `isoparse()`로 파싱하고, 현재 시간(UTC 기준)과 비교하여 만료 시간(예: 6시간)이 지났는지 확인합니다.
    4. **[Cache HIT]:** 캐시가 유효하면, TMDB API를 호출하지 않고 DB에 저장된 데이터를 즉시 사용자에게 반환합니다.
    5. **[Cache MISS]:** 캐시가 없거나 만료되었으면, `tmdb_service`를 통해 TMDB API를 호출하여 새로운 데이터를 가져옵니다.
    6. **캐시 저장:** 가져온 새 데이터를 `cached_lists` 테이블에 `upsert` (기존 항목이 있으면 덮어쓰기)하고 사용자에게 반환합니다.

### 2.3. '이번 주 최고의 인물' 기능 (트렌드 탭)
- **역할(Role):** 주간 박스오피스 상위권 영화들에 가장 많이 등장한 배우 또는 감독을 '이번 주 최고의 인물'로 선정하여 트렌드 탭에 노출합니다. 이는 사용자에게 최신 영화계 트렌드를 요약해서 보여주고, 특정 인물을 중심으로 영화를 탐색할 새로운 경로를 제공하여 앱의 콘텐츠 탐색 깊이를 더해주는 역할을 합니다.
- **작동 원리(Logic):**
    1. **[백엔드] `/person/weekly-popular` API:** 프론트엔드에서 API를 호출하면, 백엔드는 KOBIS API를 통해 주간 박스오피스 상위 5위 영화의 감독 및 주연 배우 목록을 추출합니다.
    2. **빈도 집계 및 최고 인물 선정:** 모든 인물의 등장 횟수를 계산하여 가장 많이 등장한 인물을 선정합니다.
    3. **TMDB 정보 연동:** 선정된 인물의 이름을 TMDB API로 조회하여 고화질 프로필 사진 URL과 주요 출연작 정보를 가져옵니다.
    4. **최종 응답 생성:** 인물 정보(ID, 이름, 사진, 관련 작품)를 조합하여 프론트엔드에 반환합니다.
    5. **[프론트엔드] UI 렌더링:** `trends.tsx`는 이 데이터를 받아 카드 형태로 표시하고, 클릭 시 해당 인물의 상세 페이지로 이동시킵니다.

### 2.4. '온보딩 좋아요'와 '일반 좋아요'의 구분 (`source` 필드)
- **역할(Role):** 사용자가 앱 가입 과정에서 표현한 초기 취향과, 앱 사용 중에 표현한 취향을 DB에서 명확하게 구분하는 역할을 합니다. 이는 향후 추천 모델 고도화 시, '사용자의 원초적 취향'과 '변화하는 취향'을 분리하여 분석할 수 있는 기반을 마련합니다.
- **작동 원리(Logic):**
    1.  **`user_ratings` 테이블 확장:** `source` 라는 텍스트 컬럼을 추가했습니다.
    2.  **API 요청 시 `source` 정보 포함:** 프론트엔드에서 평점 저장 API(`POST /ratings`)를 호출할 때, `source` 필드에 `'onboarding'` 또는 `'in_app'` 값을 담아 전송합니다.
    3.  **[백엔드] 데이터 저장:** 백엔드는 전달받은 `source` 값을 그대로 `user_ratings` 테이블에 저장합니다.

### 4.5. 온보딩 기능 상세 로직 (`onboarding/swipe.tsx`)
- **역할(Role):** 신규 가입자에게 카드 스와이프 UI를 통해 영화 호불호를 수집하여, 초기 취향 프로필을 구축하고 첫 맞춤 추천을 제공합니다.
- **작동 원리(Logic):**
    1.  **영화 목록 로딩:** 백엔드의 `/movies/onboarding` API를 통해 다양한 장르의 인기 영화 목록을 가져옵니다.
    2.  **스와이프 UI:** `react-native-deck-swiper` 라이브러리를 사용하여 영화 포스터 카드를 보여줍니다.
    3.  **스와이프 이벤트 처리:**
        -   **오른쪽 (Like):** `/ratings` API를 호출하여 `rating: 5`, `source: 'onboarding'` 으로 저장합니다.
        -   **왼쪽 (Dislike):** `/ratings` API를 호출하여 `rating: 1`, `source: 'onboarding'` 으로 저장합니다.
    4.  **온보딩 완료:** 모든 카드를 스와이프하면 완료 화면으로 이동합니다.

## 3. 작업 과정 및 트러블슈팅 (Troubleshooting Log)

이번 세션은 수많은 오류를 해결하는 과정의 연속이었습니다.

- **초기 문제:** '트렌드' 탭 UI 개편 중, `replace` 도구의 미숙한 사용으로 `trends.tsx` 파일에 `` `SyntaxError` ``가 발생했습니다.
- **연쇄 오류 (백엔드):**
    - **원인:** '최적화' 작업으로 전환 후, 백엔드 `routers/movies.py` 파일을 수정하는 과정에서 반복적인 실수가 발생했습니다.
    - **`ImportError` (`UTC`):** Python 3.11 미만 버전과의 호환성을 고려하지 않고 `` `datetime.UTC` ``를 사용하여 발생. `` `datetime.timezone` ``을 사용하도록 수정하여 해결.
    - **`IndentationError`:** `replace` 사용 시 파이썬 들여쓰기를 잘못 적용하여 발생. 수동으로 수정하여 해결.
    - **`TypeError` (`NoneType`):** API 로직에서 `None` 값을 체크하지 않고 사용하여 발생. `if nation and ...` 와 같이 안전 장치를 추가하여 해결.
    - **`NameError` (`router`):** 파일 복원 과정에서 `router = APIRouter()` 선언부가 유실되어 발생.
    - **`ValueError` (날짜 처리):** 불안정한 `strptime` 로직이 DB의 다양한 날짜 형식을 처리하지 못해 발생. `python-dateutil` 라이브러리의 `isoparse` 함수를 도입하여 근본적으로 해결.
    - **`500 Server Error` (내용물 없는 함수):** `get_top_rated_movies`, `get_recent_releases` 등 `tmdb_service.py`의 함수들이 빈 껍데기 상태였음. 실제 로직을 구현하여 해결.
    - **`404 Not Found` (API 유실):** 위의 오류들을 수정하기 위해 '파일 완전 복원'을 시도할 때마다, 함수의 내용물을 비워두거나 파일의 절반을 누락하는 치명적인 실수를 반복함. 이로 인해 API가 서버에 등록되지 않아 `404` 오류가 발생.
- **연쇄 오류 (프론트엔드):**
    - **`Text strings must be rendered within a <Text> component`:** `MovieCard.tsx`의 조건부 렌더링 로직이 `''`(빈 문자열)을 반환할 가능성이 있었음. `(condition) ? <Component/> : null` 형태로 로직을 수정하여 해결.
- **최종 해결:** 모든 자동화된 '복원' 시도를 포기하고, **기능이 온전했던 마지막 버전의 코드를 기반으로, 필수적인 버그 수정(날짜 처리, 호환성 등)만을 적용한 '진짜 최종본'으로 각 파일을 수동 덮어쓰기**하여 모든 문제를 해결했습니다.

이 기록이 앞으로의 개발에 큰 도움이 되기를 바랍니다.
