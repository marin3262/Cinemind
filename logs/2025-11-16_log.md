## 2025년 11월 16일 작업 로그

### 세션 목표
- 백엔드 API에서 발생하는 영화 상세정보 조회 오류 해결
- '둘러보기' 화면의 사용자 경험(UX) 개선을 위한 신규 기능(랜덤 노출, 더보기) 구현

---

### 1. 영화 상세정보 조회 오류 해결 (연속된 버그 수정)

오늘 세션은 사용자가 영화 상세정보를 조회할 때 발생하는 여러 오류를 해결하는 데 집중했습니다.

#### 1.1. 문제 현상: `404 Not Found` 오류
- **오류 발생 지점:** 추천 목록 또는 프로필의 '좋아요' 목록에서 특정 영화를 클릭했을 때, 상세정보를 가져오지 못하고 `404 Not Found` 오류가 발생했습니다.
- **로그 분석:**
    - `GET /movies/338969 HTTP/1.1" 404 Not Found`
    - `GET /movies/20258383 HTTP/1.1" 404 Not Found`

#### 1.2. 오류 원인 분석 및 해결 과정 (3단계)

##### **1단계: ID 종류 불일치 문제 (KOBIS vs TMDB)**
- **원인:** 추천 시스템은 KOBIS 영화 ID와 TMDB 영화 ID를 섞어서 반환하는데, 상세정보를 조회하는 `/movies/{movie_id}` API는 해당 ID를 무조건 KOBIS ID로만 간주하여 KOBIS API에 조회했습니다. TMDB ID가 KOBIS ID로 조회되니 당연히 정보를 찾을 수 없었습니다.
- **1차 해결 시도:** `routers/movies.py`의 `get_movie_detail_by_cd` 함수를 `get_movie_detail_by_id`로 변경하고, KOBIS 조회 실패 시 TMDB ID로 간주하여 다시 조회하는 **폴백(Fallback) 로직**을 추가했습니다.

##### **2단계: 1차 해결책의 논리적 오류**
- **원인:** 1차 수정 이후, KOBIS ID로 정보를 성공적으로 찾아도, 함수가 거기서 결과를 반환하고 끝나지 않고 다음 로직으로 넘어가 버리는(`pass`) 논리적 결함이 있었습니다. 결국 KOBIS ID를 TMDB ID로 다시 조회하면서 `404` 오류가 재발했습니다.
- **2차 해결 시도:** `get_movie_detail_by_id` 함수의 논리 흐름을 수정했습니다. KOBIS에서 정보를 찾으면, TMDB에서 포스터 같은 부가 정보만 가져와 결합한 뒤, **즉시 결과를 반환하고 함수를 종료**하도록 수정하여 불필요한 폴백 로직 실행을 막았습니다.

##### **3단계: Pydantic 데이터 유효성 검사 오류**
- **원인:** `404` 오류를 해결하자, 이번에는 `500 Internal Server Error`와 함께 `ValidationError`가 발생했습니다.
    1.  **genres 형식 불일치:** API가 반환해야 하는 데이터 모델(스키마)은 `genres`를 `['액션', '코미디']` 같은 문자열 리스트로 기대했지만, 실제 데이터는 `[{'genreNm': '액션'}, {'genreNm': '코미디'}]` 같은 객체 리스트였습니다.
    2.  **directors, actors `None` 값 오류:** 데이터 모델은 `directors` 필드를 항상 리스트(`[]`)로 기대했지만, DB에 따라 해당 필드 값이 `None`(값 없음)인 경우가 있어 오류가 발생했습니다.
- **3차 해결 시도:** `get_movie_detail_by_id` 함수에 **데이터 가공 로직**을 추가했습니다. Pydantic 모델에 데이터를 넣기 직전에, `genres`를 객체 리스트에서 문자열 리스트로 변환하고, `directors`나 `actors`가 `None`일 경우 빈 리스트(`[]`)로 만들어주는 처리 로직을 추가하여 데이터 형식을 통일시켰습니다.

#### 1.3. 최종 결과
- 위 3단계에 걸친 수정 끝에, ID 종류나 데이터 형식에 상관없이 모든 영화의 상세정보가 안정적으로 조회되도록 문제가 완전히 해결되었습니다.

---

### 2. '둘러보기' 화면 개선 기능 구현

기존 '둘러보기' 화면이 항상 동일한 영화 목록을 보여주는 문제를 해결하고, 사용자 편의성을 높이기 위한 신규 기능을 구현했습니다.

#### 2.1. 요구사항
- 영화 목록이 항상 고정되어 있지 않고, 랜덤하게 노출될 것.
- 각 카테고리별로 전체 목록을 볼 수 있는 '더보기' 기능이 있을 것.

#### 2.2. 구현 내용 및 작동 원리

##### **1단계: 백엔드 API 확장**
- **페이지네이션(Pagination) 기능 추가:**
    - **작업:** `트렌딩`, `현재 상영작`, `평점 높은 명작`, `장르별 영화` API들이 `page` 파라미터를 받을 수 있도록 `routers/movies.py`와 `tmdb_service.py`를 수정했습니다.
    - **원리:** 이제 프론트엔드에서 `GET /movies/trending?page=2`와 같이 요청하면, 해당 카테고리의 두 번째 페이지 영화 목록을 받아올 수 있습니다. '무한 스크롤'의 기반이 됩니다.
    - **캐시 전략:** 앱의 첫 로딩 속도를 위해 `page=1`일 경우에만 캐시를 사용하고, `page > 1`일 경우에는 항상 TMDB에서 최신 데이터를 가져오도록 구현했습니다.

- **랜덤 영화 API 신설 (`GET /movies/all-random`):**
    - **작업:** `routers/movies.py`에 새로운 API를 추가했습니다.
    - **원리:** DB에 있는 모든 영화 수를 센 뒤, 무작위 위치(offset)를 정해 요청된 개수(`limit`)만큼의 영화 데이터를 가져옵니다. `page` 번호를 `random.seed()`에 사용하여, 같은 페이지 번호에 대해서는 항상 동일한 "무작위" 목록을 반환하게 만들어 페이지네이션의 일관성을 유지했습니다.

##### **2단계: '더보기' 상세 페이지 신설**
- **작업:** `cinemind-client/app/movie-list.tsx` 파일을 신규 생성했습니다.
- **원리:** 이 페이지는 어떤 카테고리에서 들어왔는지 `title`과 `apiUrl`을 파라미터로 받습니다. 화면에 진입하면 `apiUrl`과 페이지 번호(`page`)를 `utils/api.ts`의 `getMoviesByApi` 함수로 넘겨 첫 영화 목록을 받아옵니다. 사용자가 화면을 아래로 스크롤하여 끝에 가까워지면(`onEndReached`), `page` 상태 값을 1 증가시켜 다음 페이지의 영화 목록을 API에 자동으로 요청하고, 받아온 데이터를 기존 목록 아래에 추가합니다. 이 과정이 반복되면서 **'무한 스크롤'**이 구현됩니다.

##### **3단계: '둘러보기' 화면 개편 및 통합**
- **작업:** `cinemind-client/app/(tabs)/explore.tsx` 파일을 대대적으로 수정했습니다.
- **원리:**
    1.  **'새로운 발견' 캐러셀:** 화면이 로딩될 때, 신설된 `/movies/all-random` API를 호출하여 그 결과를 '둘러보기' 최상단에 "새로운 발견"이라는 제목의 캐러셀로 보여줍니다.
    2.  **'더보기' 버튼:** 기존의 각 영화 캐러셀에 '더보기' 버튼을 추가했습니다.
    3.  **페이지 이동:** '더보기' 버튼을 누르면, Expo Router의 `router.push` 기능을 사용하여 `movie-list.tsx` 페이지로 이동합니다. 이때, 상세 페이지가 어떤 영화 목록을 보여줘야 할지 알 수 있도록 `title`('요즘 뜨는 영화')과 `apiUrl`('/movies/trending')을 파라미터로 함께 전달합니다.

---

### 3. 프로젝트 상태 요약 (다음 세션을 위해)

- **주요 기능:** 하이브리드 AI 추천, 영화 상세정보 조회, 박스오피스, 둘러보기(랜덤/카테고리별/더보기), 영화 검색, 유저 활동(평점/좋아요) 기능이 모두 구현 및 정상 작동 확인.
- **백엔드:** `uvicorn main:app --host 0.0.0.0 --port 8000`으로 실행.
- **프론트엔드:** `expo start`로 실행.
- **다음 작업 제안:** 현재 모든 핵심 기능 구현이 완료된 상태. 사용자 온보딩 과정(취향 선택)을 개선하거나, 프로필 페이지의 UI/UX를 다듬는 작업을 진행할 수 있음.
