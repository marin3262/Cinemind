## [2025-11-10] - 온보딩 기능 고도화 및 안정성 강화

### 🎯 목표
- 사용자가 선택한 기분에 맞는 영화를 온보딩 스와이프 화면에서 추천하고, 그 결과를 분석하여 사용자에게 보여주는 기능을 구현합니다.
- 앱 안정성을 저해하는 주요 오류들을 진단하고 해결하여 사용자 경험을 개선합니다.

### 💻 1단계: 온보딩 테스트 환경 개선

#### [온보딩 테스트 버튼 추가]
- **요청:** 로그인/회원가입 과정을 우회하여 온보딩 기능을 테스트하기 위해, 마이페이지에 온보딩 시작 버튼을 추가해 달라는 요청.
- **구현:**
  - `cinemind-client/app/(tabs)/profile.tsx` 파일 수정.
  - `expo-router`의 `useRouter` 훅을 임포트.
  - 기존 '로그아웃' 버튼 하단에 새로운 `TouchableOpacity` 컴포넌트('온보딩 테스트' 버튼) 추가.
  - 버튼 클릭 시 `router.push('/onboarding')`을 통해 온보딩 시작 화면으로 이동하도록 로직 구현.
- **결과:** 마이페이지에서 온보딩 플로우로 쉽게 진입하여 테스트할 수 있게 됨.

### 💻 2단계: 온보딩 영화 목록 동적 로딩 및 결과 화면 구현

#### [온보딩 스와이프 화면 영화 동적 로딩]
- **목표:** 기존의 정적 데이터를 TMDB API를 통해 가져오는 동적 영화 목록으로 교체하고, 포스터와 장르 정보를 표시.
- **구현 (백엔드):**
  - `cinemind-backend/main.py`:
    - `OnboardingMovie` Pydantic 모델 정의 (movie_id, title, poster_url, genre_name 포함).
    - `POST /movies/details` 엔드포인트 추가: 영화 ID 목록을 받아 상세 정보를 반환 (아래 결과 화면 구현에 사용).
    - `fastapi`에서 `Query`를 임포트.
    - `GET /movies/onboarding` 엔드포인트 수정: `mood: str | None = Query(None)` 파라미터를 받아 `tmdb_service.get_movies_for_onboarding` 함수로 전달.
  - `cinemind-backend/tmdb_service.py`:
    - 확장된 `GENRE_IDS` 딕셔너리 정의.
    - **`MOOD_GENRE_MAP` 딕셔너리 정의:** '신나는', '행복한' 등 기분과 TMDB 장르 ID 목록을 매핑.
    - `DEFAULT_ONBOARDING_GENRES` 리스트 정의: mood가 없을 경우 사용될 기본 장르 목록.
    - `get_movies_for_onboarding` 함수 수정: `mood` 파라미터를 받아 `MOOD_GENRE_MAP`에 따라 대상 장르 ID 목록을 동적으로 결정하고, 해당 장르의 영화를 TMDB에서 가져옴.
    - `get_details_for_movies` 함수 추가: 영화 ID 목록을 받아 TMDB에서 각 영화의 상세 정보를 비동기적으로 가져와 가공된 형태로 반환.
- **구현 (프론트엔드):**
  - `cinemind-client/components/SwipeCard.tsx`:
    - `SwipeCardProps` 타입 정의를 백엔드의 `OnboardingMovie` 모델에 맞게 `poster_url`, `genre_name` 등으로 변경.
    - 컴포넌트 내부에 장르(`movie.genre_name`)를 표시하는 `Text` 컴포넌트 추가 및 스타일 조정.
  - `cinemind-client/app/onboarding/swipe.tsx`:
    - 기존의 정적 `movieData`를 제거.
    - `useState`와 `useEffect`를 사용하여 `isLoading`, `error`, `movies`(동적 영화 목록) 상태 관리.
    - `useEffect` 내에서 `GET /movies/onboarding?mood=${moodText}` 엔드포인트를 호출하여 영화 목록을 가져오도록 수정. (`moodText`를 `useEffect`의 의존성 배열에 추가)

#### [온보딩 결과 화면 구현]
- **목표:** 스와이프 완료 후, '좋아요'한 영화 목록과 취향 분석 결과를 보여주는 화면 구현.
- **구현 (프론트엔드):**
  - `cinemind-client/app/onboarding/complete.tsx`:
    - 기존의 단순 이동 로직을 제거하고 전체 컴포넌트 재작성.
    - `useLocalSearchParams` 훅을 통해 `swipe.tsx`에서 전달받은 `liked_ids` (JSON string) 파라미터를 추출 및 파싱.
    - `useEffect` 훅 내에서 백엔드의 `POST /movies/details` 엔드포인트를 호출하여 '좋아요'한 영화들의 상세 정보를 가져옴.
    - `isLoading`, `error`, `movies` (상세 영화 목록) 상태 관리.
    - `useMemo`를 사용하여 가져온 영화 목록으로부터 가장 많이 나타난 상위 2개 장르(`topGenres`)를 분석.
    - 로딩 및 에러 상태에 따른 UI 표시.
    - 로딩 완료 시:
      - "취향 분석 완료!" 헤더 텍스트 표시.
      - `FlatList`를 사용하여 '좋아요'한 영화 포스터를 가로 스크롤 리스트로 표시.
      - `topGenres` 요약 텍스트 표시.
      - "내 취향 저장하고 추천받기" CTA 버튼 (회원가입 화면으로 이동) 추가.

### 💻 3단계: 주요 오류 수정 및 앱 안정성 강화

#### [오류 1: 온보딩 중 `/ratings` API `401 Unauthorized` 오류]
- **진단:** 온보딩 스와이프 중, 로그인되지 않은 상태에서 인증이 필요한 `/ratings` API를 호출하여 `401` 오류 발생. 평점 저장은 사용자가 로그인/회원가입을 완료한 후에 이루어져야 하는 로직상의 불일치.
- **최종 해결책:**
  - `cinemind-client/app/onboarding/swipe.tsx` 파일 수정.
  - `advanceCard` 함수 내에서 `/ratings` API를 호출하던 `authenticatedFetch` 부분을 제거.
  - 대신 '좋아요'를 누른 영화 ID를 `likedMovies`라는 로컬 state에 임시로 저장.
  - 온보딩 완료 시 (`nextIndex >= movies.length`), `likedMovies`에 저장된 ID 목록을 JSON 문자열로 직렬화하여 `/onboarding/complete` 화면으로 라우터 파라미터(`liked_ids`)로 전달.
- **결과:** 온보딩 중 불필요한 인증 오류 발생을 방지하고, 사용자 취향 데이터는 다음 단계로 안전하게 전달되도록 개선.

#### [오류 2: 결과 화면 (`complete.tsx`) `duplicate key` 오류]
- **진단:** 백엔드 `get_movies_for_onboarding` 함수에서 여러 장르에 속하는 인기 영화가 중복되어 최종 목록에 포함될 수 있으며, 프론트엔드 `movies.map()`에서 동일한 `key`(`movie_id`)를 가진 컴포넌트가 존재하여 React 오류 발생.
- **최종 해결책:**
  - `cinemind-backend/tmdb_service.py` 파일 수정.
  - `get_movies_for_onboarding` 함수 내에 `seen_movie_ids = set()`을 추가하여, 이미 최종 목록에 추가된 영화 ID를 기록.
  - 영화를 목록에 추가하기 전, 해당 영화 ID가 `seen_movie_ids`에 없는 경우에만 추가하고 ID를 `seen_movie_ids`에 기록하도록 로직을 변경하여 중복 제거.
- **결과:** 프론트엔드로 전달되는 영화 목록에서 `movie_id` 중복 문제가 해결되어 `duplicate key` 오류가 사라짐.

#### [오류 3: 결과 화면 (`complete.tsx`) `useEffect` 무한 루프]
- **진단:** `complete.tsx`의 `useEffect` 훅이 의존성 배열로 `params` 객체 전체를 사용하고 있었음. `useLocalSearchParams`가 리렌더링 시마다 새로운 `params` 객체를 반환하여 `useEffect`가 무한 반복 실행되고, 백엔드에 `POST /movies/details` 요청이 폭주하는 현상 발생.
- **최종 해결책:**
  - `cinemind-client/app/onboarding/complete.tsx` 파일 수정.
  - `useEffect`의 의존성 배열을 `[params]`에서 `[params.liked_ids]`로 변경. `liked_ids`는 문자열이므로 내용이 바뀌지 않는 한 `useEffect`가 재실행되지 않아 무한 루프 문제 해결.
- **결과:** 결과 화면 로딩 시 백엔드 요청이 한 번만 이루어지며, 앱의 자원 소모 및 서버 부하 문제 해결.

#### [오류 4: 메인 화면 KOBIS `503 Server Error`로 인한 앱 비정상 종료]
- **진단:** 외부 KOBIS API의 `503 Service Unavailable` 오류로 인해 백엔드 `/movies/box-office` 엔드포인트가 `500 Internal Server Error`를 반환하고, 이로 인해 프론트엔드 메인 화면이 비정상 종료되는 문제. 앱이 외부 API 장애에 취약한 구조.
- **최종 해결책:**
  - `cinemind-backend/main.py` 파일 수정.
  - `get_box_office_live` 함수 내에서 `get_daily_box_office()` 호출이 `None`을 반환(즉, KOBIS API 호출 실패)할 경우, `HTTPException(status_code=500, ...)`을 발생시키는 대신 빈 리스트 `[]`를 반환하도록 로직 변경.
- **결과:** KOBIS API 장애 시에도 앱의 메인 화면이 비정상 종료되지 않고, 박스오피스 목록만 비어있는 상태로 정상 동작하여 앱의 안정성과 사용자 경험 개선.

### ✅ 최종 진단 및 상태
- **완료된 기능:**
  - 마이페이지에 온보딩 테스트 버튼 추가.
  - 온보딩 스와이프 화면에서 기분에 따른 동적 영화 목록 추천 (백엔드 기분-장르 매핑 및 API 수정, 프론트엔드 API 호출 수정).
  - 온보딩 결과 화면 구현 (좋아요한 영화 목록 표시, 선호 장르 분석, 회원가입 CTA).
- **해결된 문제:**
  - 온보딩 중 `401 Unauthorized` 오류 (백엔드 평점 API 호출 제거 및 로컬 데이터 관리).
  - 온보딩 결과 화면 `duplicate key` 오류 (백엔드 영화 목록 중복 제거).
  - 온보딩 결과 화면 `useEffect` 무한 루프 (의존성 배열 수정).
  - 메인 화면 KOBIS API 장애로 인한 `500 Internal Server Error` 및 앱 비정상 종료 (백엔드 폴백 로직 추가).
- **현재 상태:**
  - 핵심 온보딩 플로우가 완전히 구현 및 안정화됨.
  - 앱의 주요 화면(메인, 온보딩)의 안정성이 대폭 강화됨.
  - 여전히 `AuthContext.tsx`는 임시 로그인 우회 상태이며, 실제 로그인/회원가입 기능은 테스트되지 않았음.

### 📝 다음 세션을 위한 제안
- **1순위:** `AuthContext.tsx`의 로그인 우회 코드를 제거하고, 실제 로그인/회원가입 기능과 온보딩에서 수집된 취향 데이터(liked_ids)의 연동을 구현하여 최종 테스트.
- **2순위:** 백엔드 로그에서 간헐적으로 보이던 `/movies/recommendations` 엔드포인트의 `500` 오류를 분석하고 수정.
- **3순위:** 추가 기능(검색, 프로필 상세 편집 등) 구현 착수.
- **4순위:** 전체적인 코드 정리 및 주석 추가.

---

## [2025-11-10] - 로그인/회원가입 기능 복구 및 최종 디버깅

### 🎯 목표
- 이전 세션에서 구현 보류 상태였던 실제 '로그인/회원가입' 기능을 활성화하고, 온보딩 과정에서 수집된 사용자 취향 데이터(`liked_ids`)를 회원가입 시 함께 저장하는 로직을 구현하여 인증 플로우를 완성하는 것을 목표로 설정.

### 💻 1단계: 로그인 기능 복구 및 온보딩 연동 구현
- **`AuthContext.tsx` 수정:** 로그인 우회(bypass)를 위해 하드코딩되어 있던 `authState`의 초기값을 `authenticated: false`로 변경하여, 앱 시작 시 실제 인증 과정을 거치도록 수정.
- **온보딩-회원가입 데이터 연동:**
  1. **백엔드 (`main.py`):**
     - `UserCreate` Pydantic 모델에 `liked_movie_ids: List[int] | None = None` 필드 추가.
     - `/signup` 엔드포인트에 `liked_movie_ids`가 요청으로 들어오면, 해당 영화들을 `user_ratings` 테이블에 기본 평점(5점)으로 저장하는 로직 추가.
  2. **프론트엔드 (`AuthContext.tsx`, `complete.tsx`, `signup.tsx`):**
     - `AuthContext`의 `signup` 함수가 `likedMovieIds`를 인자로 받을 수 있도록 수정.
     - 온보딩 완료 화면(`complete.tsx`)의 "내 취향 저장하고 추천받기" 버튼 클릭 시, `liked_ids`를 `signup.tsx` 화면으로 파라미터로 전달하도록 수정.
     - 회원가입 화면(`signup.tsx`)에서 전달받은 `liked_ids`를 `onSignup` 함수 호출 시 함께 전달하도록 수정.

---

### 💻 2단계: `Network request failed` 오류 재발 및 심층 디버깅
- **문제 발생:** 로그인 기능 복구 직후, 과거에 발생했던 `Network request failed` 오류가 로그인/회원가입 시도 시 동일하게 재발. 하지만 메인 화면의 박스오피스(`GET /movies/box-office`) 정보는 정상적으로 로드됨.

- **가설 1: IP 주소 변경 문제**
  - **진단:** `GET` 요청은 성공하므로, 클라이언트-서버 간 기본 연결은 정상. 하지만 `POST` 요청만 실패하는 상황. `constants/config.ts`의 `API_BASE_URL`이 이전 IP(`192.168.50.98`)로 되어 있는 것을 확인.
  - **시도:** `ifconfig`로 확인한 현재 IP 주소(`192.168.50.133`)로 `config.ts`를 수정.
  - **결과:** 문제 해결 실패. 여전히 `POST` 요청에서만 `Network request failed` 발생.

- **가설 2: 백엔드 서버 실행 방식 문제**
  - **진단:** 사용자가 `python main.py`로 서버를 실행하고 있었음을 확인. 이 방식은 FastAPI 서버를 정상적으로 실행시키지 못함.
  - **시도:** `uvicorn main:app --host 0.0.0.0 --port 8000` 명령어로 서버를 실행하도록 안내.
  - **결과:** 문제 해결 실패.

- **가설 3: CORS(Cross-Origin Resource Sharing) 정책 부재**
  - **진단:** `GET` 요청과 달리, `POST`와 같은 요청은 브라우저/앱의 더 엄격한 CORS 정책의 영향을 받음. `main.py`에 CORS 관련 설정이 없는 것을 확인.
  - **시도:** `main.py`에 `CORSMiddleware`를 추가하여 모든 출처(`*`)의 요청을 허용하도록 설정.
  - **결과:** 문제 해결 실패.

- **가설 4: 백엔드 서버 즉시 충돌 (Silent Crash)**
  - **진단:** `POST` 요청을 받는 순간, 응답을 보내기도 전에 서버 내부 오류로 인해 프로세스가 즉시 종료되어 클라이언트 입장에서는 '네트워크 실패'로 보인다는 가설 수립. Supabase 클라이언트 초기화 실패를 유력한 용의자로 특정.
  - **시도 1 (환경 변수 확인):** `supabase_client.py`가 `.env` 파일로부터 `SUPABASE_URL`, `SUPABASE_KEY` 등을 읽어오는 것을 확인. 사용자가 `.env` 파일 및 내용이 정상임을 확인.
  - **시도 2 (연결 격리 테스트):** Supabase 연결만 테스트하는 `test_supabase.py` 스크립트를 작성하여 실행.
  - **결과 (결정적 단서):** 테스트 스크립트 실행 결과, 네트워크 오류가 아닌 `AuthApiError: Invalid login credentials` 오류가 정상적으로 출력됨. **이는 파이썬 환경에서 Supabase 서버까지의 통신 자체는 완벽히 정상임을 증명.**
  - **진짜 원인 발견:** 문제는 네트워크가 아니라, FastAPI 앱이 Supabase로부터 받은 `AuthApiError`를 정상적으로 처리하지 못하고 충돌하는 것이었음.

- **최종 해결 시도:**
  - `main.py`의 `/login`, `/signup` 엔드포인트에서 `except Exception` 대신 `except AuthApiError`를 명시적으로 잡아내도록 예외 처리 로직을 강화.

---

### 💻 3단계: 프론트엔드 오류 수정 및 최종 테스트
- **추가 오류 발견:** 디버깅 중, 회원가입 화면에서 `ReferenceError: Property 'useLocalSearchParams' doesn't exist` 오류가 발생하는 것을 확인.
- **원인 및 해결:** `app/(auth)/signup.tsx` 파일에 `useLocalSearchParams` 훅을 `expo-router`로부터 `import`하는 구문이 누락되어 발생. 임포트 구문을 추가하여 해결.

- **최종 테스트 및 미해결:**
  - **시도:** 위의 모든 수정사항(백엔드 오류 처리 강화, 프론트엔드 참조 오류 수정)을 적용하고 다시 로그인 시도.
  - **결과:** 여전히 `Network request failed` 오류 발생. 마지막 디버깅 단계로, `/login` 엔드포인트 최상단에 `print`문을 추가하여 요청이 도달하는지 확인.
  - **최종 확인:** **로그인 요청 시 백엔드 터미널에 아무런 로그도 찍히지 않음.**

### ✅ 최종 진단 및 상태
- **해결된 문제:**
  - 백엔드 서버의 잘못된 실행 방식 수정 (`uvicorn` 사용).
  - 클라이언트의 API 주소 동기화.
  - 백엔드 CORS 정책 부재 문제 해결.
  - Supabase 클라이언트 통신 정상 동작 확인.
  - 백엔드의 `AuthApiError` 예외 처리 로직 강화.
  - 회원가입 화면의 `useLocalSearchParams` 참조 오류 해결.

- **미해결 문제:**
  - **근본 원인:** `GET` 요청은 서버에 정상 도달하지만, `POST` 요청은 앱에서 출발한 후 백엔드에 도달하기 전, iOS 또는 Expo Go의 네트워킹 레이어 어딘가에서 알 수 없는 이유로 차단되고 있음. 이는 코드 로직의 문제가 아닌, 특정 환경에 국한된 문제로 강력하게 추정됨.

- **조치:**
  - 수차례의 디버깅에도 불구하고 해결되지 않는 환경 문제로 최종 결론.
  - 사용자의 초기 요청에 따라, 더 이상의 시간 소모를 막고 다른 기능 개발을 진행할 수 있도록 **프로젝트의 모든 코드를 이번 세션 시작 전의 '로그인 우회' 상태로 원상 복구.**
  - (`AuthContext.tsx`, `main.py`, `signup.tsx`, `complete.tsx` 등의 모든 변경사항을 되돌리고 관련 임시 파일 삭제 완료)

- **현재 상태:**
  - 앱은 다시 **로그인 우회 모드**로 작동. `AuthContext.tsx`가 항상 로그인 된 것으로 간주하므로, 인증 과정 없이 다른 기능들을 테스트하고 개발할 수 있음.

### 📝 다음 세션을 위한 제안
- **1순위:** 현재 개발 환경에서는 로그인/회원가입 기능의 완전한 테스트가 어려우므로, 이 기능은 잠시 보류하고 **검색, 프로필 상세 기능, 추천 로직 고도화 등 다른 핵심 기능 구현에 집중**할 것을 제안.
- **2순위:** 향후 Expo SDK 버전을 업데이트하거나, 다른 네트워크 환경(예: 다른 Wi-Fi) 또는 다른 기기에서 테스트할 기회가 있을 때 로그인 기능을 다시 한번 시도해볼 수 있음.
