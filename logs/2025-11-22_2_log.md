# 2025-11-22 (세션 2): 온보딩 오류 해결 및 추천 로직 고도화

## 1. 세션 요약 (Session Summary)

본 세션은 사용자의 온보딩 플로우가 중단되는 치명적인 오류를 해결하는 것으로 시작되었습니다. 원인 분석 결과, 과거 리팩토링 과정에서 누락된 여러 API 엔드포인트가 문제의 근원이었습니다. 단계별 트러블슈팅을 통해 총 3개의 연쇄적인 백엔드 오류를 해결하여 온보딩 기능을 완전히 정상화했습니다.

이후, '둘러보기' 탭과 '홈' 탭 추천 기능의 품질과 일관성을 근본적으로 개선하는 작업으로 전환했습니다. 너무 엄격한 필터로 인해 영화가 추천되지 않던 문제를 해결하기 위해, 여러 단계에 걸쳐 조건을 완화하며 재검색하는 **'지능형 폴백(Fallback) 로직'**을 새롭게 도입했습니다. 또한, 홈 화면 추천의 편차 문제를 해결하기 위해 **'상위 N개 페이지 동시 조회'** 로직을 구현하여 추천의 안정성과 품질을 대폭 향상시켰습니다.

결론적으로, 이번 세션은 단순 버그 수정을 넘어, 프로젝트의 핵심 추천 로직 2개를 더 정교하고 사용자 친화적으로 고도화하는 데 성공한 매우 생산적인 세션이었습니다.

## 2. 작업 과정 및 트러블슈팅 로그

### 2.1. 온보딩 1단계 오류: `GET /movies/onboarding` 404 Not Found

-   **오류 현상:** 온보딩 시작 후, 기분(Mood)을 선택하면 영화 스와이프 화면으로 넘어가지 않고 멈춤.
-   **원인 분석:** 백엔드 로그에서 `GET /movies/onboarding ... 404 Not Found` 확인. 이는 스와이프 화면에 필요한 영화 목록을 가져오는 API 자체가 서버에 존재하지 않음을 의미. 과거 코드 리팩토링 과정에서 해당 API가 유실된 것으로 판단.
-   **해결책:** `routers/movies.py` 파일에 `@router.get("/movies/onboarding", ...)` 엔드포인트 함수를 복원하여 추가.

### 2.2. 온보딩 2단계 오류: `POST /movies/details` 405 Method Not Allowed

-   **오류 현상:** 1단계 오류 해결 후, 영화 스와이프를 마치자 결과 화면이 나오지 않고 멈춤.
-   **원인 분석:** 백엔드 로그에서 `POST /movies/details ... 405 Method Not Allowed` 확인. 이는 결과 화면이 '좋아요'한 영화 ID 목록으로 상세 정보를 요청하는 `POST` 방식의 API를 호출했지만, 서버에 해당 경로의 `POST` 메서드가 등록되어 있지 않다는 의미. 이 API 또한 리팩토링 중 유실된 것으로 확인.
-   **해결책:** `routers/movies.py` 파일에 `@router.post("/movies/details", ...)` 엔드포인트 함수를 복원하여 추가.

### 2.3. 온보딩 3단계 오류: `AttributeError` in `get_movies_details_in_bulk`

-   **오류 현상:** 2단계 오류 해결 후, 결과 화면 진입 시 `500 Internal Server Error` 발생.
-   **원인 분석:** 백엔드 전체 오류 로그(`Traceback`)를 분석한 결과, `AttributeError: 'MovieIdList' object has no attribute 'movie_ids'` 메시지 발견. 이는 제가 `MovieIdList`라는 데이터 모델의 실제 속성 이름(`ids`)을 `movie_ids`로 잘못 추측하고 코드를 작성했기 때문에 발생한 명백한 버그.
-   **해결책:**
    1.  `schemas.py` 파일을 읽어 `MovieIdList` 모델의 실제 속성이 `ids: List[int]` 임을 확인.
    2.  `routers/movies.py` 파일의 `get_movies_details_in_bulk` 함수 내에서 `movie_ids.movie_ids`로 잘못 작성된 부분을 올바른 속성 이름인 `movie_ids.ids`로 수정. (수정 과정에서 `replace` 도구 사용에 몇 차례 실수가 있었으나, 최종적으로 함수 전체를 올바른 코드로 덮어쓰는 방식으로 완벽히 해결)

### 2.4. '둘러보기' 탭 `404` 오류 분석 및 로직 개선으로 전환

-   **현상:** 모든 온보딩 기능이 정상화된 후, 백엔드 로그에 간헐적으로 `GET /movies/genre/53 ... 404 Not Found` 오류가 남아있음을 확인.
-   **원인 분석:** 이는 '스릴러' 장르에 대해 너무 엄격한 필터(지역, 평점 수 등)를 적용하여 TMDB에서 반환된 영화가 0건이었기 때문.
-   **사용자 피드백 및 계획 전환:** 단순 필터 완화 대신, "추천 품질을 유지하면서도 결과가 없는 상황을 방지하는 체계적인 방법"을 마련해달라는 사용자 요청에 따라, 아래 '지능형 폴백 로직'을 계획하고 구현하는 작업으로 전환.

## 3. 주요 변경 기능 상세 분석

### 3.1. 지능형 폴백 장르 추천 (수정된 기능)

-   **대상 파일:** `tmdb_service.py`
-   **함수명:** `get_movies_by_genre`
-   **기능의 역할(Role):**
    -   '둘러보기' 탭에서 사용자가 특정 장르를 탐색할 때, **결과가 없는 빈 화면을 절대 보지 않도록 보장**하는 역할을 합니다. 동시에, 가장 이상적인 조건의 영화를 우선적으로 보여줌으로써 **추천의 품질을 최대한 유지**하는 것이 핵심입니다.
-   **작동 원리(Mechanism & Logic):**
    1.  **헬퍼 함수 `_get_movies_by_genre_base`:** 먼저, 장르 ID, 페이지, 지역, 최소 평점 수 등 모든 조건을 파라미터로 받아 TMDB API를 직접 호출하는 기본 함수를 구현합니다.
    2.  **메인 함수 `get_movies_by_genre`:** 이 함수는 위 헬퍼 함수를 '재료'로 사용하여, 4단계에 걸친 계층적 검색을 수행합니다.
        -   **1순위 (Best):** '한국'의 '인기 있는(평점 수 100개 이상)' 영화를 검색합니다.
        -   **2순위 (Next Best):** 1순위 결과가 5편 미만일 경우, '전 세계'의 '인기 있는' 영화로 범위를 넓혀 재검색합니다.
        -   **3순위 (Good Enough):** 2순위도 실패하면, '한국'의 '숨겨진(평점 수 10개 이상)' 영화를 검색하여 신작이나 매니아 영화를 찾아냅니다.
        -   **4순위 (Last Resort):** 3순위까지 모두 실패하면, 모든 필터를 제거하고 해당 장르의 영화를 무조건 찾아내어 반환합니다.
-   **변경 사유(Reason for Change):**
    -   **기존 문제:** 기존 로직은 비어있었거나, 단일 조건으로만 검색하여 특정 장르(예: 한국 스릴러 인기작)에 해당하는 영화가 없으면 `404` 오류를 그대로 반환했습니다.
    -   **개선 효과:** 새로운 폴백 시스템은 **실패에 유연하게 대응**합니다. 가장 좋은 추천을 먼저 시도하되, 실패하면 점차 범위를 넓혀가며 어떻게든 사용자에게 콘텐츠를 제공합니다. 이로써 '빈 화면'이라는 최악의 사용자 경험을 방지하고, 앱의 콘텐츠 탐색 능력을 훨씬 풍부하고 안정적으로 만들었습니다.

### 3.2. 홈 화면 감성 추천 (수정된 기능)

-   **대상 파일:** `tmdb_service.py`
-   **함수명:** `get_movies_for_home_mood`
-   **기능의 역할(Role):**
    -   홈 화면의 '하이브리드 추천'을 위한 초기 '후보군'을 생성하는 역할을 합니다. 이 후보군의 질과 양, 그리고 일관성이 최종 추천 결과에 결정적인 영향을 미칩니다.
-   **작동 원리(Mechanism & Logic):**
    1.  **병렬 요청 준비:** 사용자가 기분을 선택하면, 해당 장르의 인기 영화 목록 1, 2, 3 페이지에 대한 API 요청 작업을 각각 준비합니다.
    2.  **동시 요청 실행:** `asyncio.gather`를 사용하여 3개의 요청을 동시에 병렬로 실행, 응답 시간을 최소화합니다.
    3.  **결과 취합 및 중복 제거:** 3개 페이지(약 60편)의 영화 목록을 하나의 거대한 리스트로 합칩니다. 이 과정에서 서로 다른 페이지에 동일한 영화가 포함될 수 있으므로, 영화 ID를 `set`에 기록하여 중복을 완벽히 제거합니다.
    4.  **최종 후보군 반환:** 중복이 제거된 안정적이고 풍부한 후보군(최대 60편)을 추천 로직의 다음 단계로 전달합니다.
-   **변경 사유(Reason for Change):**
    -   **기존 문제:** 기존 로직은 **단 1개의 페이지만을 무작위로** 가져왔습니다. 이는 마치 좁은 그물로 물고기를 잡는 것과 같아서, 우연히 잡힌 후보군에 사용자가 이미 본 영화가 많으면 추천할 영화가 거의 남지 않는 높은 편차와 불안정성을 야기했습니다.
    -   **개선 효과:** 이제는 항상 **상위 60편이라는 넓고 안정적인 그물**로 시작합니다. 이로 인해 '운'에 따라 추천 결과가 크게 달라지는 현상이 사라졌습니다. 추천 시스템은 항상 풍부한 재료를 가지고 개인화를 수행할 수 있게 되어, **더 일관되고 품질 높은 추천**을 안정적으로 제공할 수 있게 되었습니다.

### 3.3. 복구된 온보딩 API (복구된 기능)

-   **대상 파일:** `routers/movies.py`
-   **엔드포인트:** `GET /movies/onboarding`, `POST /movies/details`
-   **기능의 역할(Role):**
    -   `GET /movies/onboarding`: 온보딩 과정에서 사용자가 스와이프할 영화 카드 목록을 제공합니다.
    -   `POST /movies/details`: 스와이프 완료 후, 사용자가 '좋아요'한 영화 ID 목록을 받아 해당 영화들의 상세 정보(포스터, 장르 등)를 결과 화면에 제공합니다.
-   **변경 사유(Reason for Change):**
    -   이 기능들은 새로운 로직이 추가된 것이 아니라, 과거의 대규모 리팩토링 과정에서 **실수로 코드베이스에서 완전히 삭제되었던 것을 복원**한 것입니다. 이 API들의 부재가 이번 세션 초반에 발생했던 모든 온보딩 관련 오류의 직접적인 원인이었습니다.
