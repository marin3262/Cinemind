# CineMind 프로젝트 기능 명세서

## 1. 핵심 백엔드 및 공통 기능

### 1.1. 사용자 인증 (Authentication)
- **목적:** 사용자를 식별하고 개인화된 경험(평점, 찜하기, 추천 등)을 제공하기 위한 기반을 마련합니다.
- **동작 방식:**
    1. **회원가입 (`/signup`):** 사용자가 이메일, 아이디, 비밀번호를 입력하면, 백엔드는 유효성 검사 및 중복 확인을 거쳐 `profiles` 테이블에 사용자 정보를 저장합니다. 온보딩 과정에서 '좋아요'한 영화가 있다면, `user_ratings` 테이블에 `source: 'onboarding'`과 함께 저장됩니다.
    2. **로그인 (`/login`):** 사용자가 이메일과 비밀번호로 로그인을 시도하면, 백엔드는 Supabase Auth를 통해 인증하고 성공 시 JWT(JSON Web Token)를 발급합니다.
    3. **인증 상태 관리 (프론트엔드):** 클라이언트는 `AuthContext`를 통해 앱 전역의 인증 상태(로그인 여부, 사용자 정보, 토큰)를 관리합니다. 발급받은 토큰은 `expo-secure-store`를 사용해 기기에 안전하게 저장됩니다.
    4. **인증된 요청:** `utils/api.ts`의 `authenticatedFetch` 함수는 API 요청 시마다 저장된 토큰을 헤더에 담아 보냅니다. 백엔드는 이 토큰을 검증하여 현재 사용자를 식별합니다.
    5. **보안 (RLS):** Supabase의 RLS(Row-Level Security) 정책을 적극적으로 활용하여, 예를 들어 `user_ratings` 테이블은 사용자 본인의 데이터만 수정/조회할 수 있도록 통제합니다.

### 1.2. API 응답 캐싱 (Caching)
- **목적:** TMDB, KOBIS 등 외부 API 호출 횟수를 최소화하여 응답 속도를 높이고, 서버 부하와 비용을 절감합니다.
- **동작 방식:**
    1. **대상 API:** `트렌딩`, `현재 상영작`, `평점 높은 명작`, `장르별 영화` 등 내용이 자주 바뀌지 않는 목록성 API에 적용됩니다.
    2. **캐시 확인:** API 요청이 들어오면, 백엔드는 먼저 Supabase의 `cached_lists` 테이블에 해당 요청(`list_type`)에 대한 유효한(6시간 이내) 캐시 데이터가 있는지 확인합니다.
    3. **Cache HIT:** 유효한 캐시가 존재하면, 외부 API를 호출하지 않고 DB에 저장된 데이터를 즉시 반환합니다.
    4. **Cache MISS:** 캐시가 없거나 만료되었다면, `tmdb_service`를 통해 TMDB에서 새로운 데이터를 가져옵니다.
    5. **캐시 저장:** 가져온 새 데이터를 `cached_lists` 테이블에 저장(UPSERT)한 후, 사용자에게 반환합니다.
    6. **날짜 처리 안정성:** 다양한 형식의 날짜 문자열(ISO 8601)을 안정적으로 파싱하기 위해 `python-dateutil` 라이브러리를 도입하여 날짜 관련 오류를 원천적으로 방지합니다.

### 1.3. 영화 상세 정보 (Movie Details)
- **목적:** 사용자가 영화 포스터나 제목을 클릭했을 때, 해당 영화의 모든 상세 정보를 담은 모달(Modal) 창을 제공합니다.
- **동작 방식:**
    1. **ID 종류 구분:** 앱 내의 영화 ID는 KOBIS(숫자, `202...` 형식)와 TMDB(숫자) 두 종류가 혼재합니다. `useMovieModal` 훅은 클릭된 영화의 ID 형식을 판별하여, 각각 다른 백엔드 API(`GET /movies/kobis/{id}` 또는 `GET /movies/tmdb/{id}`)를 호출합니다.
    2. **백엔드 폴백(Fallback) 로직:** `GET /movies/{id}` API는 우선 KOBIS ID로 조회를 시도하고, 실패하면 TMDB ID로 다시 조회하는 폴백 로직을 통해 어떤 종류의 ID가 들어와도 처리할 수 있습니다.
    3. **데이터 통합 및 가공:** 백엔드는 KOBIS, TMDB, 그리고 내부 DB(`user_ratings`)의 정보를 모두 취합합니다. 이 과정에서 `genres`나 `directors`처럼 데이터 소스마다 형식이 다른 필드들을 Pydantic 모델에 맞게 가공하여 프론트엔드에 일관된 형식으로 전달합니다.
    4. **프론트엔드 렌더링:** `MovieModal` 컴포넌트는 전달받은 모든 상세 정보(포스터, 줄거리, 감독, 배우, 나의 평점, 코멘트 등)를 사용자에게 보여줍니다.

## 2. 사용자 온보딩 (User Onboarding)

- **목적:** 신규 가입자로부터 최소한의 초기 취향 데이터를 수집하여, 앱 사용 시작과 동시에 개인화된 추천을 제공하기 위함입니다.
- **동작 방식:**
    1. **1단계 (기분 선택):** 사용자는 '신나는', '감성적인' 등 제시된 기분 키워드 중 하나를 선택합니다.
    2. **2단계 (영화 스와이프):** 선택된 기분과 연결된 장르의 영화들이 카드 형태로 나타납니다. 사용자는 `react-native-deck-swiper`로 구현된 UI를 통해 카드를 좌우로 스와이프하며 호불호를 표현합니다.
    3. **평점 저장:** 오른쪽(Like)으로 스와이프하면 `rating: 5`, 왼쪽(Dislike)은 `rating: 1`로 간주하여, 백엔드의 `/ratings` API를 통해 `user_ratings` 테이블에 `source: 'onboarding'` 플래그와 함께 저장됩니다.
    4. **3단계 (완료 및 가입 유도):** 스와이프가 끝나면 '취향 분석 완료' 화면으로 이동하여, 수집된 데이터를 기반으로 한 선호 장르를 보여주고 회원가입을 유도합니다. 가입 시, 이 때 '좋아요'한 영화 ID 목록이 함께 백엔드로 전달됩니다.

## 3. 메인 탭 기능

### 3.1. 홈 탭 (감성 큐레이션 & 박스오피스)
- **목적:** 앱의 첫 화면으로서, 복잡한 탐색 없이 사용자의 현재 기분만으로 즉각적인 맞춤 영화를 추천하고, 동시에 최신 영화계 동향(박스오피스)을 제공합니다.
- **동작 방식:**
    - **하이브리드 감성 큐레이션:**
        1. 사용자가 '기분' 버튼을 누르면, 해당 기분과 매핑된 장르 키워드가 백엔드(`GET /recommendations/mood`)로 전송됩니다.
        2. 백엔드는 먼저 사용자의 과거 평점 기록을 분석하여 '개인 취향 점수'를 계산합니다.
        3. 동시에, 기분과 관련된 장르의 인기 영화 목록(TMDB)을 '후보군'으로 가져옵니다.
        4. 이 '후보군'을 사용자의 '개인 취향 점수'가 높은 순으로 재정렬하여, 기분과 취향이 모두 반영된 최종 추천 목록을 생성하고 프론트엔드에 전달합니다.
    - **인터랙티브 박스오피스:**
        1. 백엔드의 `GET /movies/box-office` API가 KOBIS에서 일일 박스오피스 순위를 가져옵니다.
        2. 프론트엔드는 TOP 3 영화를 `BarChart`를 이용한 수평 막대그래프로, TOP 10을 텍스트 목록으로 보여줍니다.
        3. '일별/누적' 토글 버튼을 통해, 정렬 기준을 '일일 관객수'와 '누적 관객수'로 전환하며 볼 수 있습니다.

### 3.2. 둘러보기 탭 (콘텐츠 탐색)
- **목적:** 사용자가 특정 카테고리나 장르를 중심으로 새로운 영화를 자유롭게 탐색하고 '발견'의 즐거움을 느낄 수 있는 공간입니다.
- **동작 방식:**
    - **다양한 캐러셀 목록:**
        1. **새로운 발견:** 앱 DB에 저장된 영화 중, 완전히 무작위로 몇 편을 선택하여 `/movies/all-random` API를 통해 제공합니다. 이 목록은 페이지를 열 때마다 바뀝니다.
        2. **정의된 카테고리:** '요즘 뜨는 영화', '현재 상영작', '평점 높은 명작' 등 미리 정의된 카테고리별 영화 목록을 TMDB API와 연동하여 캐러셀 형태로 보여줍니다.
        3. **장르별 카테고리:** 백엔드의 `/genres` API로부터 KOBIS 기준의 전체 장르 목록을 받아와, 동적으로 각 장르별 영화 목록 캐러셀을 생성하여 보여줍니다.
    - **무한 스크롤 (더보기):**
        1. 각 캐러셀의 '더보기' 버튼을 누르면, 해당 카테고리의 API 주소(`apiUrl`)와 제목을 `movie-list.tsx` 페이지로 전달하며 이동합니다.
        2. `movie-list.tsx` 페이지는 전달받은 `apiUrl`에 페이지 번호를 붙여 API를 호출하고, 사용자가 스크롤을 맨 아래까지 내리면 다음 페이지를 자동으로 요청하여 목록을 계속 이어 붙이는 '무한 스크롤'을 구현합니다.

### 3.3. 트렌드 탭 (데이터 기반 인사이트)
- **목적:** 개인의 취향을 넘어, '현재 대한민국 영화 시장 전체'의 흐름과 흥미로운 데이터를 시각적으로 보여주는 데이터 저널리즘/대시보드 역할을 합니다.
- **동작 방식:**
    - **라이벌 매치업:** `GET /movies/box-office/battle` API가 KOBIS에서 '지난주 개봉작' 중 가장 흥행한 두 영화를 '라이벌'로 선정하고, 개봉 첫 주 성적과 관객 점유율 데이터를 비교하여 반환합니다. 프론트엔드는 이를 '배틀 카드' 형태로 시각화합니다.
    - **이번 주 최고의 인물:** `GET /person/weekly-popular` API가 주간 박스오피스 TOP 5 영화의 감독/배우 목록을 분석하여, 가장 자주 등장한 인물을 '최고의 인물'로 선정하고 프로필 사진과 함께 보여줍니다.
    - **(구현 예정) 차트 역주행:** `next_feature_chart_climber.md`에 기획된 기능으로, 개봉한 지 오래되었지만 순위가 오르는 영화를 보여줄 예정입니다.

### 3.4. 프로필 탭 (개인화된 리포트 및 활동 기록)
- **목적:** 사용자의 모든 활동(평점, 찜하기 등)에 대한 시각적인 피드백과 보상을 제공하여, 지속적인 활동을 유도하는 핵심 '보상' 허브입니다.
- **동작 방식:**
    - **취향 분석 리포트 (`TasteAnalysisCard`):**
        1. 백엔드의 `GET /users/me/taste-analysis` API가 사용자가 높게 평가(4점 이상)한 모든 영화를 분석합니다.
        2. 장르, 배우, 감독의 등장 횟수를 계산하여 TOP 리스트를 생성하고, 별점별 분포도를 계산합니다.
        3. 프론트엔드는 이 데이터를 받아, '선호 장르/배우/감독'을 태그 형태로, '별점 분포'는 `PieChart`를 사용하여 인포그래픽 리포트를 동적으로 생성합니다.
    - **나의 활동 목록:**
        - `GET /users/me/ratings` 와 `GET /users/me/likes` API를 통해 사용자가 평가하거나 찜한 영화 목록을 가져와 각각의 전용 페이지(`my-ratings.tsx`, `my-likes.tsx`)에 표시합니다.
    - **사용자 정보 영속성:** `AuthContext`는 로그인 시 서버로부터 받은 사용자 정보(이름, 이메일)를 토큰과 함께 기기에 저장했다가, 앱 재시작 시 자동으로 불러와 로그인 상태와 사용자 정보를 복원합니다.
